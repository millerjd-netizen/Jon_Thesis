/*
 * ================================================================
 * ANAEROBIC DIGESTER - TANK 1 ONLY (SINGLE INPUT MODE)
 * Arduino GIGA R1
 * ================================================================
 * ACTIVE PUMPS (TANK 1 ONLY):
 *   D7 = URINE
 *   D2 = KOMBUCHA (wine)
 *   D4 = SPIRULINA+FeOx+Molasses
 *
 * DISABLED PUMPS (HARD HELD OFF ALWAYS):
 *   D3, D5, D6  -> forced LOW continuously
 *
 * SENSORS:
 *   A0 = pH
 *   A1 = ORP (Grove 501Z)
 *   A2 = EC
 *   A3 = MFC
 *   D10 = Temperature (DS18B20)
 *
 * CONTROL:
 *   - Base HRT: 12 hr
 *   - Emergency HRT: 3 hr if pH outside [6.4, 7.6]
 *   - SINGLE INPUT pH control:
 *       pH < 6.7  -> URINE ONLY
 *       pH 6.7-7.3 -> SPIR+FeOx+Molasses ONLY (methanogen sweet spot)
 *       pH > 7.3  -> KOMBUCHA ONLY
 *
 * SPIRULINA+FeOx+Molasses:
 *   - Feed contains: 10 g/L FeOx, 2 g/L molasses
 *   - Dosed at full HRT rate when pH in window
 *   - Target: ~2 g/L iron oxide in tank
 *
 * TIMING:
 *   - Status print: every 2 sec
 *   - Dosing cycle: every 60 sec
 *
 * pH:
 *   - 2-point LINEAR calibration directly from pH board voltage:
 *       pH 7 buffer: 1.3299 V
 *       pH 4 buffer: 1.7746 V
 *
 * ORP:
 *   - Grove 501Z sensor with official formula
 *   - ORP = 1320 - voltage_mV - OFFSET
 *   - Calibrated with 470mV solution
 *   - Typical anaerobic range: -400 to -200 mV
 * ================================================================
 */

#include <math.h>
#include <OneWire.h>
#include <DallasTemperature.h>

// ================================================================
// SENSOR PINS (TANK 1 ONLY)
// ================================================================
const int PH_PIN_1  = A0;
const int ORP_PIN_1 = A1;
const int EC_PIN_1  = A2;
const int MFC_PIN_1 = A3;

#define TEMP_PIN_1 10

OneWire oneWire1(TEMP_PIN_1);
DallasTemperature tempBus1(&oneWire1);

// ================================================================
// PUMP PINS (TANK 1 ONLY)
// ================================================================
const int PUMP_KOMBUCHA_T1 = 2;  // D2 (was WINE)
const int PUMP_SPIRFEOX_T1 = 4;  // D4
const int PUMP_URINE_T1    = 7;  // D7

// DISABLED pumps (HARD OFF)
const int PUMP_DISABLED_1 = 3; // D3
const int PUMP_DISABLED_2 = 5; // D5
const int PUMP_DISABLED_3 = 6; // D6

// ================================================================
// ADC / VOLTAGE SETTINGS
// ================================================================
const float VREF    = 3.3f;
const int   ADC_MAX = 4095;

// ================================================================
// pH 2-POINT CALIBRATION (VOLTAGE DOMAIN)
// ================================================================
const float PH7_TRUE = 7.00f;
const float PH4_TRUE = 4.00f;

const float PH7_V = 1.3299f;   // measured in pH 7 buffer
const float PH4_V = 1.7746f;   // measured in pH 4 buffer

// pH = PH_M*V + PH_B
const float PH_M = (PH7_TRUE - PH4_TRUE) / (PH7_V - PH4_V);
const float PH_B = PH7_TRUE - (PH_M * PH7_V);

// ================================================================
// ORP CALIBRATION - GROVE 501Z OFFICIAL FORMULA
// ================================================================
// Official formula: ORP = 1320 - voltage_mV - OFFSET
// Calibrated with 470mV solution at ~1.268V raw reading
// 470 = 1320 - 1268 - OFFSET  =>  OFFSET = -418
const float ORP_OFFSET = -418.0f;  // calibration offset in mV

// ================================================================
// EC CALIBRATION (unchanged)
// ================================================================
const float EC_SLOPE_MSPERMV = 0.00864f;
const float EC_OFFSET_MS     = 0.033f;
const float EC1_A = 0.83945827233f;
const float EC1_C = -2.25543265007f;

// ================================================================
// PUMP CALIBRATION (mL per second)
// ================================================================
const float ML_PER_SEC_URINE_T1    = 0.663f;
const float ML_PER_SEC_KOMBUCHA_T1 = 0.730f;
const float ML_PER_SEC_SPIRFEOX_T1 = 0.395f;

// ================================================================
// REACTOR CONFIG
// ================================================================
const float REACTOR_VOLUME_ML = 875.0f;

const float HRT_BASE_HR      = 12.0f;
const float HRT_EMERGENCY_HR = 3.0f;

const unsigned long DOSE_INTERVAL_MS   = 60000; // 60s
const unsigned long STATUS_INTERVAL_MS = 2000;  // 2s

// ================================================================
// pH LIMITS - SINGLE INPUT MODE (UPDATED FOR METHANOGEN SWEET SPOT)
// ================================================================
const float PH_MIN_EMERGENCY = 6.4f;   // below: emergency urine
const float PH_MAX_EMERGENCY = 7.6f;   // above: emergency kombucha

// Single input thresholds - wide window for FeOx in methanogen range
const float PH_URINE_MAX     = 6.7f;   // below 6.7: urine only
const float PH_FEOX_MAX      = 7.3f;   // 6.7-7.3: FeOx only (0.6 pH window)
// above 7.3: kombucha only

// ================================================================
// DATA STRUCTURES
// ================================================================
struct SensorData {
  float pH;
  float pH_V;
  int   pH_ADC;
  float ORP_mV;
  float ORP_V;
  int   ORP_ADC;
  float EC_mS;
  float MFC_mV;
  float Temp_C;
};

struct DoseVolumes {
  float Q_urine_mL;
  float Q_kombucha_mL;
  float Q_spir_mL;
  float Q_total_mL;
  float HRT;
  bool  emergency;
};

// ================================================================
// TIMING STATE
// ================================================================
unsigned long lastDoseTime   = 0;
unsigned long lastStatusTime = 0;
unsigned long doseCount      = 0;

// ================================================================
// HELPERS
// ================================================================
float rawTo_mV(int raw) { return raw * 3300.0f / 4095.0f; }

float clamp(float v, float lo, float hi) {
  if (v < lo) return lo;
  if (v > hi) return hi;
  return v;
}

int readADC_avg(int pin, int n = 30, int delay_ms = 2) {
  long sum = 0;
  for (int i = 0; i < n; i++) {
    sum += analogRead(pin);
    delay(delay_ms);
  }
  return (int)(sum / n);
}

float adcToVolts(int adc) {
  return ((float)adc) * (VREF / (float)ADC_MAX);
}

float readDS18B20(DallasTemperature& bus) {
  bus.requestTemperatures();
  float c = bus.getTempCByIndex(0);
  if (c == DEVICE_DISCONNECTED_C || c == 85.0f) return NAN;
  if (c < -55.0f || c > 125.0f) return NAN;
  return c;
}

// ================================================================
// HARD OFF SAFETY
// ================================================================
void forceAllUnusedPumpsOff() {
  digitalWrite(PUMP_DISABLED_1, LOW);
  digitalWrite(PUMP_DISABLED_2, LOW);
  digitalWrite(PUMP_DISABLED_3, LOW);
}

void allPumpsOff() {
  digitalWrite(PUMP_URINE_T1, LOW);
  digitalWrite(PUMP_KOMBUCHA_T1, LOW);
  digitalWrite(PUMP_SPIRFEOX_T1, LOW);
  forceAllUnusedPumpsOff();
}

// ================================================================
// SENSOR READS (TANK 1)
// ================================================================
float readEC_T1_mS() {
  float ec_meas = EC_SLOPE_MSPERMV * rawTo_mV(analogRead(EC_PIN_1)) + EC_OFFSET_MS;
  return EC1_A * ec_meas + EC1_C;
}

float readMFC_T1_mV() {
  return rawTo_mV(analogRead(MFC_PIN_1));
}

float readORP_T1_mV(float voltage) {
  // Official Grove 501Z formula (adjusted for 3.3V system)
  // ORP = 1320 - voltage_mV - OFFSET
  float voltage_mV = voltage * 1000.0f;
  return 1320.0f - voltage_mV - ORP_OFFSET;
}

SensorData readTank1Sensors() {
  SensorData s;
  
  // pH reading
  s.pH_ADC = readADC_avg(PH_PIN_1, 30, 2);
  s.pH_V   = adcToVolts(s.pH_ADC);
  s.pH     = clamp(PH_M * s.pH_V + PH_B, 0.0f, 14.0f);

  // ORP reading
  s.ORP_ADC = readADC_avg(ORP_PIN_1, 30, 2);
  s.ORP_V   = adcToVolts(s.ORP_ADC);
  s.ORP_mV  = readORP_T1_mV(s.ORP_V);

  // Other sensors
  s.EC_mS  = readEC_T1_mS();
  s.MFC_mV = readMFC_T1_mV();
  s.Temp_C = readDS18B20(tempBus1);
  
  return s;
}

// ================================================================
// DOSE CALCULATION - SINGLE INPUT MODE
// ================================================================
DoseVolumes calculateDose(const SensorData& s) {
  DoseVolumes d;

  d.emergency = (s.pH < PH_MIN_EMERGENCY || s.pH > PH_MAX_EMERGENCY);
  d.HRT = d.emergency ? HRT_EMERGENCY_HR : HRT_BASE_HR;

  // Base flow rate (mL/min)
  float Q_base = REACTOR_VOLUME_ML / (d.HRT * 60.0f);

  // Initialize all to zero
  d.Q_urine_mL    = 0.0f;
  d.Q_kombucha_mL = 0.0f;
  d.Q_spir_mL     = 0.0f;

  // SINGLE INPUT LOGIC - only one pump runs at a time
  if (s.pH < PH_MIN_EMERGENCY) {
    // EMERGENCY LOW - urine only, fast HRT
    d.Q_urine_mL = Q_base;
  }
  else if (s.pH < PH_URINE_MAX) {
    // LOW (6.4 - 6.7) - urine only
    d.Q_urine_mL = Q_base;
  }
  else if (s.pH <= PH_FEOX_MAX) {
    // STABLE (6.7 - 7.3) - FeOx+molasses only (methanogen sweet spot)
    d.Q_spir_mL = Q_base;
  }
  else if (s.pH <= PH_MAX_EMERGENCY) {
    // HIGH (7.3 - 7.6) - kombucha only
    d.Q_kombucha_mL = Q_base;
  }
  else {
    // EMERGENCY HIGH - kombucha only, fast HRT
    d.Q_kombucha_mL = Q_base;
  }

  d.Q_total_mL = d.Q_urine_mL + d.Q_kombucha_mL + d.Q_spir_mL;
  return d;
}

// ================================================================
// PUMP RUNNER
// ================================================================
void runPump_mL(int pin, float mL, float mL_per_sec, const char* name) {
  if (mL <= 0.0f) {
    Serial.print(F("  SKIP "));
    Serial.print(name);
    Serial.println(F(": 0.000 mL"));
    return;
  }

  float seconds = mL / mL_per_sec;
  unsigned long ms = (unsigned long)(seconds * 1000.0f);

  // Guard: avoid 0ms pulses that do nothing
  if (ms < 30) ms = 30;

  Serial.print(F("  RUN "));
  Serial.print(name);
  Serial.print(F(": "));
  Serial.print(mL, 3);
  Serial.print(F(" mL ("));
  Serial.print(ms);
  Serial.println(F(" ms)"));

  digitalWrite(pin, HIGH);
  delay(ms);
  digitalWrite(pin, LOW);
  delay(100);
}

void executeDose(const DoseVolumes& d) {
  Serial.println(F("--- TANK 1 DOSING ---"));

  runPump_mL(PUMP_URINE_T1,    d.Q_urine_mL,    ML_PER_SEC_URINE_T1,    "URINE (D7)");
  runPump_mL(PUMP_KOMBUCHA_T1, d.Q_kombucha_mL, ML_PER_SEC_KOMBUCHA_T1, "KOMBUCHA (D2)");
  runPump_mL(PUMP_SPIRFEOX_T1, d.Q_spir_mL,     ML_PER_SEC_SPIRFEOX_T1, "SPIR+Fe+Mol (D4)");

  Serial.println(F("--- DONE ---"));
}

// ================================================================
// STATUS PRINT (EVERY 2s)
// ================================================================
const char* getPHMode(float pH) {
  if (pH < PH_MIN_EMERGENCY) return "EMERG_LOW(urine)";
  if (pH < PH_URINE_MAX)     return "LOW(urine)";
  if (pH <= PH_FEOX_MAX)     return "STABLE(FeOx)";
  if (pH <= PH_MAX_EMERGENCY) return "HIGH(kombucha)";
  return "EMERG_HIGH(kombucha)";
}

void printStatus(const SensorData& s) {
  unsigned long sec = millis() / 1000;

  bool emergency = (s.pH < PH_MIN_EMERGENCY || s.pH > PH_MAX_EMERGENCY);
  float hrt = emergency ? HRT_EMERGENCY_HR : HRT_BASE_HR;

  Serial.print(sec);
  Serial.print(F("s | pH="));
  Serial.print(s.pH, 2);
  Serial.print(F(" ("));
  Serial.print(getPHMode(s.pH));
  Serial.print(F(") "));

  Serial.print(F("| ORP="));
  Serial.print(s.ORP_mV, 0);
  Serial.print(F("mV "));

  Serial.print(F("| HRT="));
  Serial.print(hrt, 1);
  Serial.print(emergency ? F(" [EMERGENCY] ") : F(" [BASE] "));

  Serial.print(F("| V="));
  Serial.print(s.pH_V, 4);
  Serial.print(F(" ADC="));
  Serial.print(s.pH_ADC);

  Serial.print(F(" | EC="));
  Serial.print(s.EC_mS, 2);
  Serial.print(F("mS/cm"));

  Serial.print(F(" | MFC="));
  Serial.print(s.MFC_mV, 0);
  Serial.print(F("mV"));

  Serial.print(F(" | Temp="));
  if (isnan(s.Temp_C)) Serial.println(F("NA"));
  else { Serial.print(s.Temp_C, 1); Serial.println(F("C")); }
}

// ================================================================
// SETUP
// ================================================================
void setup() {
  Serial.begin(115200);
  while (!Serial);
  delay(500);

  // Pump pins
  pinMode(PUMP_URINE_T1, OUTPUT);
  pinMode(PUMP_KOMBUCHA_T1, OUTPUT);
  pinMode(PUMP_SPIRFEOX_T1, OUTPUT);

  pinMode(PUMP_DISABLED_1, OUTPUT);
  pinMode(PUMP_DISABLED_2, OUTPUT);
  pinMode(PUMP_DISABLED_3, OUTPUT);

  // Ensure everything starts OFF
  allPumpsOff();

  analogReadResolution(12);

  tempBus1.begin();
  tempBus1.setWaitForConversion(true);
  tempBus1.setResolution(12);

  Serial.println(F(""));
  Serial.println(F("================================================"));
  Serial.println(F("  ANAEROBIC DIGESTER - SINGLE INPUT MODE"));
  Serial.println(F("  Base HRT=12hr | Emergency HRT=3hr"));
  Serial.println(F("  pH < 6.7: URINE only"));
  Serial.println(F("  pH 6.7-7.3: SPIR+FeOx+Molasses only"));
  Serial.println(F("  pH > 7.3: KOMBUCHA only"));
  Serial.println(F("  Emergency if pH < 6.4 or > 7.6"));
  Serial.println(F("  Pumps: URINE=D7, KOMBUCHA=D2, SPIR+Fe=D4"));
  Serial.println(F("  Sensors: pH=A0, ORP=A1, EC=A2, MFC=A3, Temp=D10"));
  Serial.println(F("================================================"));
  Serial.println(F(""));

  Serial.println(F("pH CALIBRATION:"));
  Serial.print(F("  PH7_V=")); Serial.print(PH7_V, 4);
  Serial.print(F(" -> 7.00 | PH4_V=")); Serial.print(PH4_V, 4);
  Serial.println(F(" -> 4.00"));
  Serial.print(F("  pH = ")); Serial.print(PH_M, 6);
  Serial.print(F("*V + ")); Serial.println(PH_B, 6);
  Serial.println(F(""));

  Serial.println(F("ORP CALIBRATION (Grove 501Z):"));
  Serial.println(F("  Formula: ORP = 1320 - voltage_mV - OFFSET"));
  Serial.print(F("  OFFSET = ")); Serial.print(ORP_OFFSET, 1); Serial.println(F(" mV"));
  Serial.println(F("  Calibrated with 470mV solution"));
  Serial.println(F(""));

  Serial.println(F("pH THRESHOLDS:"));
  Serial.print(F("  URINE if pH < ")); Serial.println(PH_URINE_MAX, 2);
  Serial.print(F("  FeOx if pH ")); Serial.print(PH_URINE_MAX, 2);
  Serial.print(F(" - ")); Serial.println(PH_FEOX_MAX, 2);
  Serial.print(F("  KOMBUCHA if pH > ")); Serial.println(PH_FEOX_MAX, 2);
  Serial.println(F(""));

  Serial.println(F("PUMP CAL (mL/s):"));
  Serial.print(F("  URINE=")); Serial.println(ML_PER_SEC_URINE_T1, 3);
  Serial.print(F("  KOMBUCHA="));  Serial.println(ML_PER_SEC_KOMBUCHA_T1, 3);
  Serial.print(F("  SPIR+Fe=")); Serial.println(ML_PER_SEC_SPIRFEOX_T1, 3);
  Serial.println(F(""));

  Serial.println(F("CSVHEADER,Time_s,pH,pH_V,pH_ADC,ORP_mV,ORP_V,ORP_ADC,EC_mS,MFC_mV,Temp_C,Mode,HRT,Emergency,Q_urine,Q_kombucha,Q_spir"));
  Serial.println(F(""));

  lastDoseTime = millis();
  lastStatusTime = millis();
}

// ================================================================
// MAIN LOOP
// ================================================================
void loop() {
  // Hard enforce unused pumps off at all times
  forceAllUnusedPumpsOff();

  unsigned long now = millis();

  // Status every 2 seconds
  if (now - lastStatusTime >= STATUS_INTERVAL_MS) {
    SensorData s = readTank1Sensors();
    printStatus(s);

    // CSV line
    bool emergency = (s.pH < PH_MIN_EMERGENCY || s.pH > PH_MAX_EMERGENCY);
    float hrt = emergency ? HRT_EMERGENCY_HR : HRT_BASE_HR;

    Serial.print(F("DATA,"));
    Serial.print((unsigned long)(now / 1000));
    Serial.print(F(","));
    Serial.print(s.pH, 3);
    Serial.print(F(","));
    Serial.print(s.pH_V, 4);
    Serial.print(F(","));
    Serial.print(s.pH_ADC);
    Serial.print(F(","));
    Serial.print(s.ORP_mV, 1);
    Serial.print(F(","));
    Serial.print(s.ORP_V, 4);
    Serial.print(F(","));
    Serial.print(s.ORP_ADC);
    Serial.print(F(","));
    Serial.print(s.EC_mS, 3);
    Serial.print(F(","));
    Serial.print(s.MFC_mV, 1);
    Serial.print(F(","));
    if (isnan(s.Temp_C)) Serial.print(F("NA"));
    else Serial.print(s.Temp_C, 2);
    Serial.print(F(","));
    Serial.print(getPHMode(s.pH));
    Serial.print(F(","));
    Serial.print(hrt, 1);
    Serial.print(F(","));
    Serial.print(emergency ? 1 : 0);

    // Preview dose
    DoseVolumes preview = calculateDose(s);
    Serial.print(F(","));
    Serial.print(preview.Q_urine_mL, 4);
    Serial.print(F(","));
    Serial.print(preview.Q_kombucha_mL, 4);
    Serial.print(F(","));
    Serial.println(preview.Q_spir_mL, 4);

    lastStatusTime = now;
  }

  // Dose every 60 seconds
  if (now - lastDoseTime >= DOSE_INTERVAL_MS) {
    Serial.println(F(""));
    Serial.println(F("========================================"));
    Serial.println(F("======= TANK 1 DOSING CYCLE ============"));
    Serial.println(F("========================================"));

    SensorData s = readTank1Sensors();
    DoseVolumes d = calculateDose(s);

    Serial.print(F("pH: "));
    Serial.print(s.pH, 3);
    Serial.print(F(" | ORP: "));
    Serial.print(s.ORP_mV, 0);
    Serial.print(F("mV | Mode: "));
    Serial.print(getPHMode(s.pH));
    Serial.print(F(" | HRT="));
    Serial.print(d.HRT, 1);
    Serial.print(F(" hr | emergency="));
    Serial.println(d.emergency ? F("YES") : F("NO"));

    Serial.print(F("Doses (mL): urine="));
    Serial.print(d.Q_urine_mL, 4);
    Serial.print(F(" kombucha="));
    Serial.print(d.Q_kombucha_mL, 4);
    Serial.print(F(" spir="));
    Serial.print(d.Q_spir_mL, 4);
    Serial.print(F(" total="));
    Serial.println(d.Q_total_mL, 4);

    // Execute pumps
    executeDose(d);

    doseCount++;
    Serial.print(F("Dose count: "));
    Serial.println(doseCount);
    Serial.println(F("========================================"));
    Serial.println(F(""));

    lastDoseTime = now;
  }
}
